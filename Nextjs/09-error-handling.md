# 第9章：エラー処理

**この章の目標**  
プログラムでは、想定外のことが起きることがあります（ネットワークエラー、データがない、権限がない、など）。  
そういった**エラー**を、  
- **開発者向け**（ログに残して原因を追いやすくする）  
- **ユーザー向け**（「問題が起きました」「再読み込みしてみてください」など、次の行動が分かる表示）  

の2つに分けて扱うことが大切です。  
この章では、**例外を握りつぶさない**ことと、**error.tsx** でユーザーにどう見せるかを、初心者向けに説明します。

---

## エラー処理で心がけること

1. **例外を握りつぶさない**  
   「エラーが起きたのに、何もログに残さず、ユーザーにも何も伝えない」状態にしない、という意味です。  
   起きたエラーは、少なくとも**ログ**に残し、ユーザーには**分かりやすいメッセージ**と**次の行動**（再読み込み、トップへ戻るなど）を提示します。

2. **ログとユーザー向けメッセージを分ける**  
   - **ログ** … 開発者が原因を調べるための情報（スタックトレース、リクエストIDなど）。ユーザーにそのまま見せない。  
   - **ユーザー向けメッセージ** … 「申し訳ありません。しばらくしてから再度お試しください。」「再読み込み」ボタンなど、**何をすればよいか**が分かる内容にします。

Next.jsでは、**error.tsx** を置くことで、そのルート（フォルダ）以下でエラーが起きたときに、**ユーザー向けのエラー画面**を表示できます。  
その画面には「再読み込み」「トップへ戻る」などの**導線**を必ず用意することがベストプラクティスです。

---

## error.tsx の役割

- **error.tsx** は、そのフォルダ（ルート）以下で**エラーが発生したとき**に、Next.jsが自動的に表示するコンポーネントです。  
- ここでは、  
  - ユーザーに「問題が起きました」と伝える  
  - **再試行**（もう一度読み込む）や**トップへ戻る**などのボタンを出す  
  といった内容を書きます。  
- エラーの詳細（スタックトレースなど）は、**開発時**はコンソールやログで確認し、**本番**ではユーザーには見せないようにします。

---

## 例題：error.tsx でユーザー向けエラー画面を出す

次の例は、**app/error.tsx** または **app/dashboard/error.tsx** のように置く想定です。  
**use client** が必要な理由は、Next.js の error 境界がクライアントでレンダリングされるためです。  
「再読み込み」と「トップへ戻る」の2つの導線を用意しています。  
各行にコメントを付けています。

```tsx
// ファイル名: app/error.tsx（または app/dashboard/error.tsx）
"use client";
// error.tsx では、Next.js の仕様でクライアントコンポーネントとして扱う必要があります

import { useEffect } from "react";

type ErrorProps = {
  error: Error & { digest?: string };
  // Next.js が渡してくれるエラーオブジェクト。digest はエラーを識別するためのIDのことがあります
  reset: () => void;
  // reset を呼ぶと、エラーが起きた部分を「もう一度読み込む」ように試みます
};

export default function ErrorUI({ error, reset }: ErrorProps) {
  useEffect(() => {
    console.error(error);
    // 開発者用：エラー内容をコンソールに残します。本番ではログ送信サービスに送ることもあります
    // ユーザーには、この error オブジェクトをそのまま見せないようにします
  }, [error]);

  return (
    <div
      style={{
        padding: "2rem",
        textAlign: "center",
        maxWidth: "400px",
        margin: "2rem auto",
      }}
    >
      <h2>問題が発生しました</h2>
      {/* ユーザーには、技術的な内容ではなく、分かりやすい短文で伝えます */}
      <p style={{ margin: "1rem 0", color: "#666" }}>
        申し訳ありません。しばらくしてから再度お試しください。
      </p>
      <div style={{ display: "flex", gap: "1rem", justifyContent: "center" }}>
        <button
          onClick={() => reset()}
          style={{
            padding: "0.5rem 1rem",
            backgroundColor: "#0070f3",
            color: "white",
            border: "none",
            borderRadius: "4px",
            cursor: "pointer",
          }}
        >
          再読み込み
        </button>
        {/* reset を呼ぶと、該当する部分の再レンダリングが試みられます */}
        <a
          href="/"
          style={{
            padding: "0.5rem 1rem",
            backgroundColor: "#eee",
            color: "#333",
            borderRadius: "4px",
            textDecoration: "none",
          }}
        >
          トップへ戻る
        </a>
        {/* トップページへのリンクを必ず用意し、ユーザーが次の行動を選べるようにします */}
      </div>
    </div>
  );
}
```

---

## 例題：サーバー側でエラーをログに残す

Route Handler や Server Component の中でエラーが起きたときは、**握りつぶさず**ログに残し、ユーザーには適切なレスポンスやメッセージを返します。  
次の例は、Route Handler で try-catch を使い、ログとユーザー向けメッセージを分けています。

```ts
// ファイル名の例: app/api/orders/route.ts
import { NextResponse } from "next/server";

export async function GET() {
  try {
    const data = await fetchOrdersFromDB();
    // 実際のデータ取得処理（例：データベースや外部API）
    return NextResponse.json(data);
  } catch (err) {
    console.error("GET /api/orders failed:", err);
    // 開発者用：何が起きたかをログに残します。本番ではログ集約サービスに送ることもあります
    return NextResponse.json(
      { error: "注文の取得中に問題が発生しました。しばらくしてから再度お試しください。" },
      { status: 500 }
    );
    // ユーザー向けには、技術的な詳細ではなく、次の行動が分かるメッセージを返します
  }
}
```

---

## まとめ

- エラーは**握りつぶさず**、少なくとも**ログ**に残す。ユーザーには**分かりやすいメッセージ**と**次の行動**（再読み込み、トップへ戻る）を提示する。
- **error.tsx** では「問題が起きました」と伝え、「**再読み込み**」「**トップへ戻る**」などの導線を必ず用意する。
- ログ（開発者向け）とユーザー向けメッセージは分けて扱う。スタックトレースなどをそのまま画面に出さない。

---

これで、Next.js App Router + TypeScript のベストプラクティスを、各章ごとのMDファイルとして一通りまとめました。  
目次は **README.md** にまとめてあります。わからない章があれば、そこから読み返してみてください。
